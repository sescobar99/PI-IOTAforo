<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <title>Test: consume API</title>
</head>

<body>
  <div class="container" id="main-container">
  </div>


</body>

<script type="text/javascript">
  function addOccupancyBarToDom(block, room, full_occupancy, actual_occupancy, threshold) {
    ratio_occupancy = ratioOccupancy(actual_occupancy, full_occupancy, threshold);
    color = barColor(ratio_occupancy);

    var container = document.getElementById('main-container');
    let progressbar = document.createElement('div');
    let progress = document.createElement('div');
    let text = document.createElement('p');
    let br = document.createElement('br');

    progressbar.classList.add('progress-bar');
    progressbar.classList.add(`bg-${color}`);
    progressbar.style.width = `${ratio_occupancy * 100}%`;
    progressbar.ariaValueNow = ratio_occupancy * 100;
    progressbar.ariaValueMin = 0;
    progressbar.ariaValueMax = 100
    progressbar.innerHTML = (ratio_occupancy * 100).toFixed(1) + '%';

    progress.classList.add('progress');

    text.innerText = `B:${block} R:${room} Hay actualmente ${actual_occupancy} personas, de las ${Math.ceil(threshold * full_occupancy)} permitidas.
    (Capacidad max. ${full_occupancy} / Trabajando al ${threshold * 100}%)`;

    progress.appendChild(progressbar);
    container.appendChild(progress);
    container.appendChild(text);
    container.appendChild(br);
  }

  function sortRoomsByOccupancy(a, b) {
    actual_occupancy_a = a.payload === undefined ? 0 : JSON.parse(a.payload).actual_occupancy;
    ratio_occupancy_a = ratioOccupancy(actual_occupancy_a, a.full_occupancy, a.threshold);

    actual_occupancy_b = b.payload === undefined ? 0 : JSON.parse(b.payload).actual_occupancy;
    ratio_occupancy_b = ratioOccupancy(actual_occupancy_b, b.full_occupancy, b.threshold);

    if (ratio_occupancy_a <= ratio_occupancy_b) return 1;
    else return -1;
  }

  function barColor(ratio_occupancy) {
    if (ratio_occupancy < (0.5)) {
      color = 'success'
    } else if (ratio_occupancy < (0.8)) {
      color = 'warning';
    } else {
      color = 'danger';
    }
    return color;
  }

  function ratioOccupancy(actual_occupancy, full_occupancy, threshold) {
    return actual_occupancy / (full_occupancy * threshold);
  }
</script>
<script type="text/javascript">
  fetch('https://a0xtwzmka9.execute-api.us-east-2.amazonaws.com/items')
    .then(response => response.json())
    .then(data => {
      items = data.Items;
      items.sort(sortRoomsByOccupancy);

      items.forEach(item => {
        block = item.block;
        room = item.room;
        full_occupancy = item.full_occupancy;
        actual_occupancy = item.payload === undefined ? 0 : JSON.parse(item.payload).actual_occupancy;
        threshold = item.threshold;

        addOccupancyBarToDom(block, room, full_occupancy, actual_occupancy, threshold);

      });

    })
</script>



</html>